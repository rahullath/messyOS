---
// src/pages/settings.astro - User Settings and Preferences Page
import Layout from '../layouts/Layout.astro';
import { createServerAuth } from '../lib/auth/simple-multi-user';

// Require authentication
const serverAuth = createServerAuth(Astro.cookies);
const user = await serverAuth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Get user preferences
const preferences = await serverAuth.getUserPreferences(user.id);

if (!preferences) {
  // Create default preferences if they don't exist
  console.log('⚠️ No preferences found, creating defaults...');
  await serverAuth.createDefaultPreferences(user.id, user.email);
  return Astro.redirect('/settings');
}

// Calculate trial status
const trialEndDate = preferences.trial_end_date ? new Date(preferences.trial_end_date) : null;
const now = new Date();
const daysLeft = trialEndDate ? Math.max(0, Math.ceil((trialEndDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24))) : 0;
---

<Layout title="Settings - meshOS">
  <div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div class="container mx-auto px-6 py-8 max-w-4xl">
      
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-white mb-2">Settings</h1>
        <p class="text-gray-300">Customize your meshOS experience</p>
      </div>

      <!-- User Info -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">Account Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">Email</label>
            <p class="text-white bg-gray-800 px-3 py-2 rounded">{user.email}</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-1">User ID</label>
            <p class="text-gray-400 text-sm font-mono bg-gray-800 px-3 py-2 rounded truncate">{user.id}</p>
          </div>
        </div>
      </div>

      <!-- Subscription Status -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">Subscription</h2>
        <div class="flex items-center justify-between">
          <div>
            <p class="text-white mb-1">
              Status: <span class="capitalize font-semibold text-cyan-400">{preferences.subscription_status}</span>
            </p>
            {preferences.subscription_status === 'trial' && (
              <p class="text-gray-300 text-sm">
                Trial ends: {trialEndDate?.toLocaleDateString()} ({daysLeft} days left)
              </p>
            )}
          </div>
          {preferences.subscription_status === 'trial' && (
            <button 
              id="extend-trial"
              class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded transition-colors"
            >
              Extend Trial (+7 days)
            </button>
          )}
        </div>
      </div>

      <!-- Theme Settings -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">Theme & Appearance</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Theme</label>
            <select 
              id="theme-select" 
              class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2"
              data-current={preferences.theme}
            >
              <option value="dark">Dark</option>
              <option value="light">Light</option>
              <option value="midnight">Midnight</option>
              <option value="forest">Forest</option>
              <option value="sunset">Sunset</option>
              <option value="ocean">Ocean</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Accent Color</label>
            <input 
              type="color" 
              id="accent-color" 
              value={preferences.accent_color}
              class="w-full h-10 bg-gray-800 border border-gray-600 rounded"
            />
          </div>
        </div>
      </div>

      <!-- Enabled Modules -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">Active Modules</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="modules-grid">
          {['habits', 'tasks', 'health', 'finance', 'content', 'social', 'travel', 'home'].map((module) => (
            <label class="cursor-pointer flex items-center space-x-2">
              <input 
                type="checkbox" 
                value={module}
                checked={preferences.enabled_modules?.includes(module)}
                class="rounded"
              />
              <span class="text-white capitalize">{module}</span>
            </label>
          ))}
        </div>
      </div>

      <!-- AI Settings -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-4">AI Assistant</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Personality</label>
            <select 
              id="ai-personality" 
              class="w-full bg-gray-800 text-white border border-gray-600 rounded px-3 py-2"
              data-current={preferences.ai_personality}
            >
              <option value="professional">Professional Coach</option>
              <option value="friendly">Friendly Mentor</option>
              <option value="analytical">Data Scientist</option>
              <option value="motivational">Life Coach</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">
              Proactivity Level: <span id="proactivity-value">{preferences.ai_proactivity_level}</span>
            </label>
            <input 
              type="range" 
              id="ai-proactivity" 
              min="1" 
              max="5" 
              value={preferences.ai_proactivity_level}
              class="w-full accent-cyan-500"
            />
            <div class="flex justify-between text-sm text-gray-400 mt-1">
              <span>Passive</span>
              <span>Very Proactive</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Exit Gate Template -->
      <div class="bg-black/20 backdrop-blur-sm border border-white/10 rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold text-white mb-2">Exit Gate Template</h2>
        <p class="text-gray-300 text-sm mb-4">
          Customize your default exit checklist. These conditions seed your day and can still be adjusted in Chain View.
        </p>

        <div id="exit-gate-list" class="space-y-3"></div>

        <div class="mt-4 flex flex-col sm:flex-row gap-3">
          <input
            id="new-exit-gate-label"
            type="text"
            maxlength="60"
            placeholder="New condition label (e.g., Wallet, Laptop charger)"
            class="flex-1 bg-gray-800 text-white border border-gray-600 rounded px-3 py-2"
          />
          <button
            id="add-exit-gate-condition"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition-colors"
          >
            Add Condition
          </button>
        </div>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row gap-4">
        <button 
          id="save-settings"
          class="bg-cyan-600 hover:bg-cyan-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors flex-1"
        >
          Save Settings
        </button>
        <button 
          id="reset-settings"
          class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors"
        >
          Reset to Defaults
        </button>
      </div>

      <!-- Status Message -->
      <div id="message" class="hidden mt-4 p-4 rounded-lg text-center"></div>
    </div>
  </div>

  <script>
    import { preferencesClient } from '../lib/auth/preferences-client';

    type GateCondition = {
      id: string;
      name: string;
      satisfied: boolean;
    };

    const DEFAULT_EXIT_GATE_CONDITIONS: GateCondition[] = [
      { id: 'keys', name: 'Keys present', satisfied: false },
      { id: 'phone', name: 'Phone charged >= 20%', satisfied: false },
      { id: 'water', name: 'Water bottle filled', satisfied: false },
      { id: 'meds', name: 'Meds taken', satisfied: false },
      { id: 'cat-fed', name: 'Cat fed', satisfied: false },
      { id: 'bag-packed', name: 'Bag packed', satisfied: false },
      { id: 'eyeglasses', name: 'Eyeglasses', satisfied: false },
    ];

    let exitGateTemplate: GateCondition[] = [];

    function slugifyConditionId(label: string): string {
      const base = label
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
      return base || `condition-${Date.now()}`;
    }

    function normalizeGateConditions(raw: unknown): GateCondition[] {
      if (!Array.isArray(raw)) {
        return DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
      }

      const parsed = raw
        .map((item) => {
          if (!item || typeof item !== 'object') return null;
          const record = item as Record<string, unknown>;
          const id = typeof record.id === 'string' ? record.id : null;
          if (!id) return null;

          const fallbackName = DEFAULT_EXIT_GATE_CONDITIONS.find((c) => c.id === id)?.name || id;
          return {
            id,
            name: typeof record.name === 'string' ? record.name : fallbackName,
            satisfied: Boolean(record.satisfied),
          } as GateCondition;
        })
        .filter((condition): condition is GateCondition => Boolean(condition));

      const conditionMap = new Map<string, GateCondition>();
      for (const condition of DEFAULT_EXIT_GATE_CONDITIONS) {
        conditionMap.set(condition.id, { ...condition });
      }
      for (const condition of parsed) {
        conditionMap.set(condition.id, condition);
      }

      return Array.from(conditionMap.values());
    }

    function escapeHtml(value: string): string {
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderExitGateTemplate() {
      const container = document.getElementById('exit-gate-list');
      if (!container) return;

      if (exitGateTemplate.length === 0) {
        container.innerHTML = `
          <div class="text-sm text-gray-400 border border-gray-700 rounded p-3">
            No conditions configured. Add one below.
          </div>
        `;
        return;
      }

      container.innerHTML = exitGateTemplate
        .map((condition, index) => `
          <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_auto] gap-3 items-center border border-gray-700 rounded p-3">
            <input
              type="text"
              value="${escapeHtml(condition.name)}"
              data-exit-gate-name-index="${index}"
              class="bg-gray-800 text-white border border-gray-600 rounded px-3 py-2"
              maxlength="60"
            />
            <label class="inline-flex items-center space-x-2 text-sm text-gray-200">
              <input
                type="checkbox"
                ${condition.satisfied ? 'checked' : ''}
                data-exit-gate-checked-index="${index}"
                class="rounded"
              />
              <span>Checked by default</span>
            </label>
            <button
              data-exit-gate-remove-index="${index}"
              class="bg-red-600/80 hover:bg-red-600 text-white px-3 py-2 rounded transition-colors text-sm"
            >
              Remove
            </button>
          </div>
        `)
        .join('');
    }

    async function loadExitGateTemplate() {
      try {
        const response = await fetch('/api/daily-plan/exit-gate-template');
        if (!response.ok) {
          exitGateTemplate = DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
          renderExitGateTemplate();
          return;
        }

        const payload = await response.json();
        exitGateTemplate = normalizeGateConditions(payload?.gate_conditions);
        renderExitGateTemplate();
      } catch (error) {
        console.error('Failed to load exit gate template:', error);
        exitGateTemplate = DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
        renderExitGateTemplate();
      }
    }

    async function saveExitGateTemplate(): Promise<boolean> {
      try {
        const response = await fetch('/api/daily-plan/exit-gate-template', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            gate_conditions: exitGateTemplate,
          }),
        });

        return response.ok;
      } catch (error) {
        console.error('Save exit gate template error:', error);
        return false;
      }
    }
    
    // Initialize current values
    document.addEventListener('DOMContentLoaded', () => {
      // Set current theme
      const themeSelect = document.getElementById('theme-select') as HTMLSelectElement;
      if (themeSelect) {
        themeSelect.value = themeSelect.dataset.current || 'dark';
      }
      
      // Set current AI personality
      const aiPersonalitySelect = document.getElementById('ai-personality') as HTMLSelectElement;
      if (aiPersonalitySelect) {
        aiPersonalitySelect.value = aiPersonalitySelect.dataset.current || 'professional';
      }

      loadExitGateTemplate();
    });

    document.getElementById('exit-gate-list')?.addEventListener('input', (event) => {
      const target = event.target as HTMLInputElement;
      const nameIndex = target.dataset.exitGateNameIndex;
      const checkedIndex = target.dataset.exitGateCheckedIndex;

      if (nameIndex !== undefined) {
        const index = Number(nameIndex);
        if (!Number.isNaN(index) && exitGateTemplate[index]) {
          exitGateTemplate[index] = {
            ...exitGateTemplate[index],
            name: target.value.trimStart(),
          };
        }
      }

      if (checkedIndex !== undefined) {
        const index = Number(checkedIndex);
        if (!Number.isNaN(index) && exitGateTemplate[index]) {
          exitGateTemplate[index] = {
            ...exitGateTemplate[index],
            satisfied: target.checked,
          };
        }
      }
    });

    document.getElementById('exit-gate-list')?.addEventListener('click', (event) => {
      const target = event.target as HTMLElement;
      const removeIndex = target.dataset.exitGateRemoveIndex;
      if (removeIndex === undefined) return;

      const index = Number(removeIndex);
      if (Number.isNaN(index) || !exitGateTemplate[index]) return;

      exitGateTemplate.splice(index, 1);
      renderExitGateTemplate();
    });

    document.getElementById('add-exit-gate-condition')?.addEventListener('click', () => {
      const input = document.getElementById('new-exit-gate-label') as HTMLInputElement;
      if (!input) return;

      const label = input.value.trim();
      if (!label) return;

      const baseId = slugifyConditionId(label);
      let id = baseId;
      let suffix = 2;
      while (exitGateTemplate.some((condition) => condition.id === id)) {
        id = `${baseId}-${suffix++}`;
      }

      exitGateTemplate.push({
        id,
        name: label,
        satisfied: false,
      });

      input.value = '';
      renderExitGateTemplate();
    });

    // Update proactivity level display
    const proactivitySlider = document.getElementById('ai-proactivity') as HTMLInputElement;
    const proactivityValue = document.getElementById('proactivity-value');
    
    if (proactivitySlider && proactivityValue) {
      proactivitySlider.addEventListener('input', () => {
        proactivityValue.textContent = proactivitySlider.value;
      });
    }

    // Show message function
    function showMessage(text: string, type: 'success' | 'error' | 'info' = 'info') {
      const messageEl = document.getElementById('message');
      if (messageEl) {
        messageEl.textContent = text;
        messageEl.className = `mt-4 p-4 rounded-lg text-center ${
          type === 'error' ? 'bg-red-900/50 text-red-200 border border-red-800' : 
          type === 'success' ? 'bg-green-900/50 text-green-200 border border-green-800' :
          'bg-blue-900/50 text-blue-200 border border-blue-800'
        }`;
        messageEl.classList.remove('hidden');
        
        setTimeout(() => {
          messageEl.classList.add('hidden');
        }, 3000);
      }
    }

    // Save settings
    document.getElementById('save-settings')?.addEventListener('click', async () => {
      try {
        showMessage('Saving settings...', 'info');
        
        // Collect all form data
        const theme = (document.getElementById('theme-select') as HTMLSelectElement).value;
        const accentColor = (document.getElementById('accent-color') as HTMLInputElement).value;
        const aiPersonality = (document.getElementById('ai-personality') as HTMLSelectElement).value;
        const aiProactivity = parseInt((document.getElementById('ai-proactivity') as HTMLInputElement).value);
        
        // Get enabled modules
        const moduleCheckboxes = document.querySelectorAll('#modules-grid input[type="checkbox"]');
        const enabledModules: string[] = [];
        moduleCheckboxes.forEach((checkbox) => {
          if ((checkbox as HTMLInputElement).checked) {
            enabledModules.push((checkbox as HTMLInputElement).value);
          }
        });
        
        // Update preferences
        const success = await preferencesClient.updatePreferences({
          theme,
          accent_color: accentColor,
          enabled_modules: enabledModules,
          module_order: enabledModules,
          ai_personality: aiPersonality,
          ai_proactivity_level: aiProactivity
        });

        const gateTemplateSaved = await saveExitGateTemplate();
        
        if (success && gateTemplateSaved) {
          showMessage('Settings saved successfully!', 'success');
        } else if (success && !gateTemplateSaved) {
          showMessage('General settings saved, but exit gate template failed to save.', 'error');
        } else {
          showMessage('Failed to save settings. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Save settings error:', error);
        showMessage('An error occurred while saving settings.', 'error');
      }
    });

    // Reset settings
    document.getElementById('reset-settings')?.addEventListener('click', async () => {
      if (confirm('Are you sure you want to reset all settings to defaults?')) {
        try {
          showMessage('Resetting settings...', 'info');
          
          const success = await preferencesClient.resetToDefaults();
          exitGateTemplate = DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
          const gateResetSuccess = await saveExitGateTemplate();
          
          if (success && gateResetSuccess) {
            showMessage('Settings reset to defaults!', 'success');
            setTimeout(() => {
              window.location.reload();
            }, 1500);
          } else {
            showMessage('Failed to reset settings. Please try again.', 'error');
          }
        } catch (error) {
          console.error('Reset settings error:', error);
          showMessage('An error occurred while resetting settings.', 'error');
        }
      }
    });

    // Extend trial
    document.getElementById('extend-trial')?.addEventListener('click', async () => {
      try {
        showMessage('Extending trial...', 'info');
        
        const success = await preferencesClient.extendTrial();
        
        if (success) {
          showMessage('Trial extended by 7 days!', 'success');
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showMessage('Failed to extend trial. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Extend trial error:', error);
        showMessage('An error occurred while extending trial.', 'error');
      }
    });
  </script>
</Layout>
