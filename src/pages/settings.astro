---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import AccountPageShell from '../components/account/AccountPageShell.astro';
import { createServerAuth } from '../lib/auth/simple-multi-user';

const serverAuth = createServerAuth(Astro.cookies);
const user = await serverAuth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

const preferences = await serverAuth.getUserPreferences(user.id);

const enabledModules = Array.isArray(preferences?.enabled_modules) ? preferences.enabled_modules : ['habits', 'tasks', 'calendar'];
const theme = typeof preferences?.theme === 'string' ? preferences.theme : 'dark';
---

<DashboardLayout title="Settings - MeshOS" user={user}>
  <AccountPageShell
    title="Settings"
    description="Useful controls only. Changes here are saved to your backend preferences."
    activeTab="settings"
  >
    <section class="card">
      <h2 class="text-lg font-semibold text-text-primary mb-4">Appearance</h2>
      <form id="appearance-form" class="grid grid-cols-1 gap-4 max-w-md">
        <div>
          <label for="theme" class="block text-sm text-text-muted mb-1">Theme</label>
          <select id="theme" class="w-full rounded-lg border border-border bg-background px-3 py-2 text-text-primary">
            <option value="dark" selected={theme === 'dark'}>Dark</option>
            <option value="light" selected={theme === 'light'}>Light</option>
            <option value="midnight" selected={theme === 'midnight'}>Midnight</option>
            <option value="ocean" selected={theme === 'ocean'}>Ocean</option>
          </select>
        </div>
        <div>
          <button type="submit" class="px-4 py-2 rounded-lg bg-accent-primary text-white text-sm font-medium hover:bg-accent-primary/90 transition-colors">Save appearance</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold text-text-primary mb-2">Modules</h2>
      <p class="text-sm text-text-secondary mb-4">
        Module selection is saved now, but module-level hiding is still partial in some screens.
      </p>
      <form id="modules-form" class="space-y-4">
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 text-sm">
          {['habits', 'tasks', 'calendar', 'daily-plan', 'finance', 'health', 'content'].map((module) => (
            <label class="inline-flex items-center gap-2 rounded-lg border border-border bg-surface-hover/50 px-3 py-2">
              <input type="checkbox" name="enabled_modules" value={module} checked={enabledModules.includes(module)} />
              <span class="text-text-primary capitalize">{module}</span>
            </label>
          ))}
        </div>
        <button type="submit" class="px-4 py-2 rounded-lg border border-border text-text-secondary text-sm font-medium hover:text-text-primary hover:bg-surface-hover transition-colors">Save modules</button>
      </form>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold text-text-primary mb-2">Exit Gate Template</h2>
      <p class="text-sm text-text-secondary mb-4">
        Manage your default leave-home checklist. This seeds each day and can still be changed in Chain View.
      </p>

      <div id="exit-gate-list" class="space-y-3"></div>

      <div class="mt-4 flex flex-col sm:flex-row gap-3">
        <input
          id="new-exit-gate-label"
          type="text"
          maxlength="60"
          placeholder="New condition label (e.g., Wallet, Laptop charger)"
          class="flex-1 rounded-lg border border-border bg-background px-3 py-2 text-text-primary"
        />
        <button
          id="add-exit-gate-condition"
          class="px-4 py-2 rounded-lg border border-border text-text-secondary text-sm font-medium hover:text-text-primary hover:bg-surface-hover transition-colors"
        >
          Add Condition
        </button>
      </div>
    </section>

    <div id="settings-message" class="hidden rounded-lg border border-border p-3 text-sm"></div>
  </AccountPageShell>
</DashboardLayout>

<script>
  const message = document.getElementById('settings-message');

  function showMessage(text, isError = false) {
    if (!message) return;
    message.textContent = text;
    message.classList.remove('hidden');
    message.classList.toggle('text-accent-error', isError);
    message.classList.toggle('text-text-primary', !isError);
  }

  document.getElementById('appearance-form')?.addEventListener('submit', async (event) => {
    event.preventDefault();

    const payload = {
      theme: document.getElementById('theme')?.value || 'dark',
    };

    const response = await fetch('/api/auth/preferences', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    const result = await response.json();
    showMessage(response.ok ? 'Appearance saved' : (result?.error || 'Save failed'), !response.ok);
  });

  document.getElementById('modules-form')?.addEventListener('submit', async (event) => {
    event.preventDefault();

    const enabled_modules = Array.from(document.querySelectorAll('input[name="enabled_modules"]:checked')).map((node) => node.value);

    const response = await fetch('/api/auth/preferences', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled_modules, module_order: enabled_modules }),
    });

    const result = await response.json();
    showMessage(response.ok ? 'Modules saved' : (result?.error || 'Save failed'), !response.ok);
  });

  const DEFAULT_EXIT_GATE_CONDITIONS = [
    { id: 'keys', name: 'Keys present', satisfied: false },
    { id: 'phone', name: 'Phone charged >= 20%', satisfied: false },
    { id: 'water', name: 'Water bottle filled', satisfied: false },
    { id: 'meds', name: 'Meds taken', satisfied: false },
    { id: 'cat-fed', name: 'Cat fed', satisfied: false },
    { id: 'bag-packed', name: 'Bag packed', satisfied: false },
    { id: 'eyeglasses', name: 'Eyeglasses', satisfied: false },
  ];

  let exitGateTemplate = [];

  function slugifyConditionId(label) {
    const base = label
      .toLowerCase()
      .trim()
      .replace(/[^a-z0-9\s-]/g, '')
      .replace(/\s+/g, '-')
      .replace(/-+/g, '-');
    return base || `condition-${Date.now()}`;
  }

  function normalizeGateConditions(raw) {
    if (!Array.isArray(raw)) {
      return DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
    }

    const parsed = raw
      .map((item) => {
        if (!item || typeof item !== 'object') return null;
        const id = typeof item.id === 'string' ? item.id : null;
        if (!id) return null;

        const fallbackName = DEFAULT_EXIT_GATE_CONDITIONS.find((c) => c.id === id)?.name || id;
        return {
          id,
          name: typeof item.name === 'string' ? item.name : fallbackName,
          satisfied: Boolean(item.satisfied),
        };
      })
      .filter(Boolean);

    const conditionMap = new Map();
    for (const condition of DEFAULT_EXIT_GATE_CONDITIONS) {
      conditionMap.set(condition.id, { ...condition });
    }
    for (const condition of parsed) {
      conditionMap.set(condition.id, condition);
    }

    return Array.from(conditionMap.values());
  }

  function escapeHtml(value) {
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function renderExitGateTemplate() {
    const container = document.getElementById('exit-gate-list');
    if (!container) return;

    if (exitGateTemplate.length === 0) {
      container.innerHTML = `
        <div class="text-sm text-text-secondary border border-border rounded-lg p-3">
          No conditions configured. Add one below.
        </div>
      `;
      return;
    }

    container.innerHTML = exitGateTemplate
      .map((condition, index) => `
        <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_auto] gap-3 items-center border border-border rounded-lg p-3">
          <input
            type="text"
            value="${escapeHtml(condition.name)}"
            data-exit-gate-name-index="${index}"
            class="rounded-lg border border-border bg-background px-3 py-2 text-text-primary"
            maxlength="60"
          />
          <label class="inline-flex items-center space-x-2 text-sm text-text-secondary">
            <input
              type="checkbox"
              ${condition.satisfied ? 'checked' : ''}
              data-exit-gate-checked-index="${index}"
              class="rounded"
            />
            <span>Checked by default</span>
          </label>
          <button
            data-exit-gate-remove-index="${index}"
            class="px-3 py-2 rounded-lg border border-border text-sm text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors"
          >
            Remove
          </button>
        </div>
      `)
      .join('');
  }

  async function loadExitGateTemplate() {
    try {
      const response = await fetch('/api/daily-plan/exit-gate-template');
      if (!response.ok) {
        exitGateTemplate = DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
        renderExitGateTemplate();
        return;
      }

      const payload = await response.json();
      exitGateTemplate = normalizeGateConditions(payload?.gate_conditions);
      renderExitGateTemplate();
    } catch (error) {
      console.error('Failed to load exit gate template:', error);
      exitGateTemplate = DEFAULT_EXIT_GATE_CONDITIONS.map((condition) => ({ ...condition }));
      renderExitGateTemplate();
    }
  }

  async function saveExitGateTemplate() {
    try {
      const response = await fetch('/api/daily-plan/exit-gate-template', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          gate_conditions: exitGateTemplate,
        }),
      });

      return response.ok;
    } catch (error) {
      console.error('Save exit gate template error:', error);
      return false;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    loadExitGateTemplate();
  });

  document.getElementById('exit-gate-list')?.addEventListener('input', (event) => {
    const target = event.target;
    const nameIndex = target.dataset.exitGateNameIndex;
    const checkedIndex = target.dataset.exitGateCheckedIndex;

    if (nameIndex !== undefined) {
      const index = Number(nameIndex);
      if (!Number.isNaN(index) && exitGateTemplate[index]) {
        exitGateTemplate[index] = {
          ...exitGateTemplate[index],
          name: target.value.trimStart(),
        };
      }
    }

    if (checkedIndex !== undefined) {
      const index = Number(checkedIndex);
      if (!Number.isNaN(index) && exitGateTemplate[index]) {
        exitGateTemplate[index] = {
          ...exitGateTemplate[index],
          satisfied: target.checked,
        };
      }
    }
  });

  document.getElementById('exit-gate-list')?.addEventListener('click', (event) => {
    const target = event.target;
    const removeIndex = target.dataset.exitGateRemoveIndex;
    if (removeIndex === undefined) return;

    const index = Number(removeIndex);
    if (Number.isNaN(index) || !exitGateTemplate[index]) return;

    exitGateTemplate.splice(index, 1);
    renderExitGateTemplate();
  });

  document.getElementById('add-exit-gate-condition')?.addEventListener('click', (event) => {
    event.preventDefault();

    const input = document.getElementById('new-exit-gate-label');
    const label = input?.value?.trim();

    if (!label) {
      showMessage('Enter a label before adding a condition.', true);
      return;
    }

    const id = slugifyConditionId(label);
    const duplicateId = exitGateTemplate.some((condition) => condition.id === id);
    if (duplicateId) {
      showMessage('That condition already exists. Try a different label.', true);
      return;
    }

    exitGateTemplate.push({ id, name: label, satisfied: false });
    input.value = '';
    renderExitGateTemplate();
  });

  let exitGateSaveTimer = null;
  document.getElementById('exit-gate-list')?.addEventListener('change', () => {
    if (exitGateSaveTimer) {
      window.clearTimeout(exitGateSaveTimer);
    }

    exitGateSaveTimer = window.setTimeout(async () => {
      const saved = await saveExitGateTemplate();
      showMessage(saved ? 'Exit gate template saved' : 'Failed to save exit gate template', !saved);
    }, 250);
  });
</script>
