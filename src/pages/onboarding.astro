---
// src/pages/onboarding.astro - User Onboarding Flow
import Layout from '../layouts/Layout.astro';
import { createServerAuth } from '../lib/auth/simple-multi-user';
import OnboardingFlow from '../components/onboarding/OnboardingFlow.tsx';

// Require authentication
const serverAuth = createServerAuth(Astro.cookies);
const user = await serverAuth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Check if user has already completed onboarding
const { data: preferences } = await serverAuth.supabase
  .from('user_preferences')
  .select('*')
  .eq('user_id', user.id)
  .single();

// If user has preferences, they've completed onboarding
if (preferences) {
  return Astro.redirect('/');
}
---

<Layout title="Welcome to messyOS - Setup">
  <div class="container mx-auto max-w-2xl py-12">
    <h1 class="text-3xl font-bold mb-4 text-center">Welcome to messyOS</h1>
    <p class="text-center mb-8">Let's get your workspace set up.</p>
    <OnboardingFlow client:load />
  </div>
</Layout>

<script>
  window.addEventListener('onboardingComplete', () => {
    window.location.href = '/';
  });
</script>
