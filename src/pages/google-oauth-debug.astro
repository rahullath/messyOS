---
// Google OAuth Debug Page
const appId = import.meta.env.PUBLIC_PRIVY_APP_ID;
const appSecret = import.meta.env.PRIVY_APP_SECRET;
---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Debug - MeshOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-cyan-400 mb-8">
            üîç Google OAuth Debug Console
        </h1>

        <!-- Environment Check -->
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold text-white mb-4">Environment Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <div class="flex items-center">
                        <span class="text-gray-300 w-32">App ID:</span>
                        <span class={appId ? "text-green-400" : "text-red-400"}>
                            {appId ? `‚úÖ ${appId.substring(0, 15)}...` : "‚ùå Missing"}
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-gray-300 w-32">App Secret:</span>
                        <span class={appSecret ? "text-green-400" : "text-red-400"}>
                            {appSecret ? "‚úÖ Configured" : "‚ùå Missing"}
                        </span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-gray-300 w-32">Environment:</span>
                        <span class="text-blue-400">{import.meta.env.MODE}</span>
                    </div>
                    <div class="flex items-center">
                        <span class="text-gray-300 w-32">Development:</span>
                        <span class="text-blue-400">{import.meta.env.DEV ? "Yes" : "No"}</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="text-sm text-gray-400">
                        <strong>Expected Configuration:</strong>
                        <div class="mt-2 bg-gray-900 p-3 rounded font-mono text-xs">
                            PUBLIC_PRIVY_APP_ID=cmeaj35yf006oic0cyhhppt65<br/>
                            PRIVY_APP_SECRET=2Gw2fBeZnrrjnSuEa...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Troubleshooting Checklist -->
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold text-white mb-4">üìã Troubleshooting Checklist</h2>
            <div class="space-y-3">
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="rounded">
                    <span class="text-gray-300">‚úÖ Google OAuth enabled in Privy Dashboard</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="rounded">
                    <span class="text-gray-300">‚úÖ Redirect URIs configured (localhost:4321 + production)</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="rounded">
                    <span class="text-gray-300">‚úÖ Google Cloud Console OAuth client setup</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="rounded">
                    <span class="text-gray-300">‚úÖ CORS settings allow your domain</span>
                </label>
                <label class="flex items-center space-x-3">
                    <input type="checkbox" class="rounded">
                    <span class="text-gray-300">‚úÖ Browser allows third-party cookies</span>
                </label>
            </div>
        </div>

        <!-- Common URLs to Check -->
        <div class="bg-gray-800 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-bold text-white mb-4">üîó URLs to Verify</h2>
            <div class="space-y-2 text-sm">
                <div>
                    <span class="text-gray-300">Privy Dashboard:</span>
                    <a href="https://dashboard.privy.io" target="_blank" 
                       class="text-cyan-400 hover:text-cyan-300 underline ml-2">
                        https://dashboard.privy.io
                    </a>
                </div>
                <div>
                    <span class="text-gray-300">Google Cloud Console:</span>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" 
                       class="text-cyan-400 hover:text-cyan-300 underline ml-2">
                        https://console.cloud.google.com/apis/credentials
                    </a>
                </div>
                <div>
                    <span class="text-gray-300">JWKS Endpoint:</span>
                    <a href={`https://auth.privy.io/api/v1/apps/${appId}/jwks.json`} target="_blank" 
                       class="text-cyan-400 hover:text-cyan-300 underline ml-2">
                        https://auth.privy.io/api/v1/apps/{appId ? appId.substring(0, 10) : 'APP_ID'}.../jwks.json
                    </a>
                </div>
            </div>
        </div>

        <!-- Interactive Debug Component -->
        {appId ? (
            <div id="debug-component">
                <!-- This will be populated by React -->
            </div>
        ) : (
            <div class="bg-red-900/20 border border-red-500 p-6 rounded-lg">
                <h3 class="text-red-400 font-bold text-lg mb-4">‚ùå Configuration Error</h3>
                <p class="text-red-300 mb-4">
                    PUBLIC_PRIVY_APP_ID is missing from environment variables.
                </p>
                <p class="text-red-200 text-sm">
                    Add your App ID to the .env file to continue debugging.
                </p>
            </div>
        )}

        <!-- Instructions -->
        <div class="mt-8 bg-blue-900/20 border border-blue-500 p-6 rounded-lg">
            <h3 class="text-blue-300 font-bold text-lg mb-4">üìö Debug Instructions</h3>
            <ol class="text-blue-200 text-sm space-y-2 list-decimal list-inside">
                <li>Check that all environment variables are set correctly</li>
                <li>Verify Google OAuth is enabled in your Privy Dashboard</li>
                <li>Test the login flow and check browser developer console for errors</li>
                <li>Monitor network requests to identify any failed API calls</li>
                <li>Check for CORS or cookie-related issues in the console</li>
            </ol>
        </div>

        <!-- Navigation -->
        <div class="mt-6 text-center space-x-4">
            <a href="/privy-simple-test" class="text-cyan-400 hover:text-cyan-300 underline">
                ‚Üê Simple Privy Test
            </a>
            <a href="/working-privy" class="text-gray-400 hover:text-gray-300 underline">
                Working Privy Test
            </a>
        </div>
    </div>

    <!-- Load Debug Component -->
    {appId && (
        <script type="module">
            import { PrivyProvider } from 'https://esm.sh/@privy-io/react-auth@2.21.4';
            import React from 'https://esm.sh/react@18';
            import { createRoot } from 'https://esm.sh/react-dom@18/client';

            // Import our debug component (simulated - you would need to build this properly)
            const GoogleOAuthDebug = () => {
                const [ready, setReady] = React.useState(false);
                const [authenticated, setAuthenticated] = React.useState(false);
                const [user, setUser] = React.useState(null);
                const [logs, setLogs] = React.useState([]);

                const addLog = (message) => {
                    const timestamp = new Date().toLocaleTimeString();
                    setLogs(prev => [...prev.slice(-9), `[${timestamp}] ${message}`]);
                    console.log('Debug:', message);
                };

                React.useEffect(() => {
                    addLog('üîß Google OAuth Debug component mounted');
                }, []);

                return React.createElement('div', {
                    className: 'bg-gray-800 p-6 rounded-lg space-y-4'
                }, [
                    React.createElement('h3', {
                        key: 'title',
                        className: 'text-green-400 font-bold text-lg'
                    }, 'üß™ Live Debug Console'),
                    
                    React.createElement('div', {
                        key: 'logs',
                        className: 'bg-black p-4 rounded-lg min-h-[200px]'
                    }, [
                        React.createElement('h4', {
                            key: 'logs-title',
                            className: 'text-green-400 font-semibold mb-2'
                        }, 'Console Logs:'),
                        React.createElement('div', {
                            key: 'logs-content',
                            className: 'space-y-1 text-sm font-mono text-gray-300'
                        }, logs.length > 0 ? logs.map((log, i) => 
                            React.createElement('div', { key: i }, log)
                        ) : ['Debug component loaded - try logging in...'])
                    ])
                ]);
            };

            // Wrapper with Privy Provider
            const DebugApp = () => {
                return React.createElement(PrivyProvider, {
                    appId: '{appId}',
                    config: {
                        loginMethods: ['email', 'google', 'wallet'],
                        appearance: {
                            theme: 'dark',
                            accentColor: '#06b6d4',
                        },
                        embeddedWallets: {
                            createOnLogin: 'users-without-wallets',
                            requireUserPasswordOnCreate: false,
                        }
                    },
                    onSuccess: (user) => {
                        console.log('‚úÖ Privy login successful:', user);
                    },
                    onError: (error) => {
                        console.error('‚ùå Privy error:', error);
                    }
                }, React.createElement(GoogleOAuthDebug));
            };

            // Mount the debug app
            const container = document.getElementById('debug-component');
            if (container) {
                const root = createRoot(container);
                root.render(React.createElement(DebugApp));
            }
        </script>
    )}
</body>
</html>