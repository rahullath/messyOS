---
// src/pages/habits/analytics.astro - Habits Analytics Dashboard
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import { createServerClient } from '../../lib/supabase/server';

const supabase = createServerClient(Astro.cookies);

// Get the user from session
const { data: { user } } = await supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Fetch user's habits for analytics
const { data: habits, error: habitsError } = await supabase
  .from('habits')
  .select('*')
  .eq('user_id', user.id)
  .eq('is_active', true)
  .order('created_at', { ascending: false });

if (habitsError) {
  console.error('Error fetching habits:', habitsError);
}

// Get date range for analytics (last 90 days)
const endDate = new Date();
const startDate = new Date();
startDate.setDate(startDate.getDate() - 90);

// Fetch habit entries for analytics
const { data: entries, error: entriesError } = await supabase
  .from('habit_entries')
  .select('*')
  .eq('user_id', user.id)
  .gte('date', startDate.toISOString().split('T')[0])
  .lte('date', endDate.toISOString().split('T')[0])
  .order('date', { ascending: true });

if (entriesError) {
  console.error('Error fetching habit entries:', entriesError);
}

const habitsData = habits || [];
const entriesData = entries || [];
---

<DashboardLayout title="Habits Analytics - MessyOS">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-semibold text-text-primary mb-2">Habits Analytics</h1>
        <p class="text-text-secondary">
          Discover patterns and insights in your habit tracking
        </p>
      </div>
      <div class="flex space-x-3">
        <a 
          href="/habits" 
          class="flex items-center px-4 py-2 bg-surface border border-border text-text-primary rounded-lg hover:bg-surface-hover transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Back to Habits
        </a>
        <button 
          id="export-btn"
          class="flex items-center px-4 py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 transition-colors"
        >
          <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m0 0l3 3m-3-3h8M4 20h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          Export Data
        </button>
      </div>
    </div>

    <!-- Analytics Dashboard Container -->
    <div id="analytics-dashboard"></div>
  </div>

  <!-- Pass data to React component -->
  <script type="application/json" data-habits>
    {JSON.stringify(habitsData)}
  </script>
  
  <script type="application/json" data-entries>
    {JSON.stringify(entriesData)}
  </script>

  <!-- Load Analytics Dashboard Component -->
  <script>
    import('../../components/habits/HabitsAnalyticsDashboard.tsx').then(module => {
      const { HabitsAnalyticsDashboard } = module;
      const container = document.getElementById('analytics-dashboard');
      if (container) {
        // This would be rendered by React in a real implementation
        // For now, we'll create a placeholder
        container.innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-2 border-accent-primary border-t-transparent rounded-full mx-auto mb-4"></div><p class="text-text-secondary">Loading analytics dashboard...</p></div>';
      }
    });
  </script>
</DashboardLayout>

<script>
  // Export functionality
  document.getElementById('export-btn')?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/habits/analytics/export', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          format: 'csv',
          dateRange: 90
        })
      });

      if (!response.ok) {
        throw new Error('Export failed');
      }

      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `habits-analytics-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      // Show success message
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-accent-success text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = '✅ Analytics data exported successfully!';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);

    } catch (error) {
      console.error('Export error:', error);
      
      // Show error message
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-accent-error text-white px-6 py-3 rounded-lg shadow-lg z-50';
      toast.innerHTML = '❌ Failed to export analytics data';
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  });
</script>
</DashboardLayout>