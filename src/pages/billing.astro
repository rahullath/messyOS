---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import AccountPageShell from '../components/account/AccountPageShell.astro';
import { createServerAuth } from '../lib/auth/simple-multi-user';
import { getBillingSnapshot } from '../lib/billing/subscription';

const serverAuth = createServerAuth(Astro.cookies);
const user = await serverAuth.getUser();
if (!user) {
  return Astro.redirect('/login');
}

const preferences = await serverAuth.getUserPreferences(user.id);
const billing = getBillingSnapshot(preferences);
const status = Astro.url.searchParams.get('status');
---

<DashboardLayout title="Subscription - MeshOS" user={user}>
  <AccountPageShell
    title="Subscription"
    description="Clear pricing, clear status. No hidden steps."
    activeTab="subscription"
  >
    {status === 'success' && (
      <div class="rounded-lg border border-accent-success/30 bg-accent-success/10 p-4 text-sm text-text-primary">
        Payment confirmed. Your subscription should update shortly.
      </div>
    )}
    {status === 'cancel' && (
      <div class="rounded-lg border border-border bg-surface-hover/70 p-4 text-sm text-text-secondary">
        Checkout was canceled. You can retry anytime.
      </div>
    )}

    <section class="card">
      <h2 class="text-lg font-semibold text-text-primary mb-4">Current Status</h2>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
        <div class="rounded-lg border border-border p-3 bg-surface-hover/50">
          <p class="text-text-muted">Plan status</p>
          <p class="mt-1 text-text-primary capitalize">{billing.status}</p>
        </div>
        <div class="rounded-lg border border-border p-3 bg-surface-hover/50">
          <p class="text-text-muted">Trial end</p>
          <p class="mt-1 text-text-primary">{billing.trialEndDate ? new Date(billing.trialEndDate).toLocaleDateString() : 'Not set'}</p>
        </div>
        <div class="rounded-lg border border-border p-3 bg-surface-hover/50">
          <p class="text-text-muted">Access</p>
          <p class="mt-1 text-text-primary">{billing.isAccessAllowed ? 'Active' : 'Locked'}</p>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 class="text-lg font-semibold text-text-primary mb-2">Pricing</h2>
      <p class="text-text-secondary text-sm mb-5">
        30-day free trial, then £1/month. Cancel anytime.
      </p>

      <button
        id="checkout-btn"
        class="w-full sm:w-auto rounded-lg bg-accent-primary hover:bg-accent-primary/90 px-5 py-3 text-white text-sm font-semibold transition-colors"
      >
        Start £1/month subscription
      </button>
      <p id="billing-message" class="mt-3 text-sm text-text-secondary"></p>
    </section>
  </AccountPageShell>
</DashboardLayout>

<script>
  const button = document.getElementById('checkout-btn');
  const message = document.getElementById('billing-message');

  button?.addEventListener('click', async () => {
    if (button) {
      button.setAttribute('disabled', 'true');
      button.textContent = 'Opening checkout...';
    }

    try {
      const response = await fetch('/api/stripe/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      });
      const result = await response.json();
      if (!response.ok || !result?.url) {
        throw new Error(result?.error || 'Failed to create checkout session');
      }
      window.location.href = result.url;
    } catch (error) {
      if (message) {
        message.textContent = error instanceof Error ? error.message : 'Checkout failed';
      }
      if (button) {
        button.removeAttribute('disabled');
        button.textContent = 'Start £1/month subscription';
      }
    }
  });
</script>
