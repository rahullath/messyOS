---
import DashboardLayout from '../layouts/DashboardLayout.astro';
import { createServerAuth } from '../lib/auth/simple-multi-user';
import { AILifeCoach } from '../lib/intelligence/ai-life-coach';
import { AnalyticsDashboard } from '../components/analytics/AnalyticsDashboard';

// Require authentication
const serverAuth = createServerAuth(Astro.cookies);
const user = await serverAuth.getUser();

if (!user) {
  return Astro.redirect('/login');
}

// Use the server-side Supabase client that already has authentication
const aiLifeCoach = new AILifeCoach(serverAuth.supabase);
const dailyPlan = await aiLifeCoach.generateDailyPlan(user.id, new Date());
---

<DashboardLayout title="AI Dashboard - MessyOS" user={user}>
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-semibold text-text-primary mb-2">AI Dashboard</h1>
        <p class="text-text-secondary">
          Your personalized life optimization dashboard
        </p>
      </div>
    </div>

    <!-- AI Life Coach Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">Today's Plan</h2>
        <p class="text-text-secondary mb-4">
          Here is your personalized plan for today, generated by your AI Life Coach:
        </p>
        <ul class="space-y-2">
          {dailyPlan.scheduled_blocks?.map((block: any) => (
            <li class="flex items-center">
              <span class="font-semibold mr-2">{new Date(block.scheduled_start_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}:</span>
              <span>{block.title}</span>
            </li>
          ))}
        </ul>
      </div>
      <div class="card">
        <h2 class="text-xl font-semibold mb-4">Productivity Coaching</h2>
        <p class="text-text-secondary">
          {await aiLifeCoach.getProductivityCoaching(user.id)}
        </p>
      </div>
    </div>

    <!-- Analytics Dashboard -->
    <AnalyticsDashboard client:load userId={user.id} />
  </div>
</DashboardLayout>
