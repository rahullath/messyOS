---
// src/pages/test-mobile-quick-actions.astro - Test page for mobile quick actions
import Layout from '../layouts/Layout.astro';

const mockHabits = [
  {
    id: 'habit-1',
    name: 'Exercise',
    type: 'build',
    measurement_type: 'boolean',
    color: '#10B981',
    streak_count: 5,
    allows_skips: false,
    completedToday: false
  },
  {
    id: 'habit-2',
    name: 'Meditation',
    type: 'build',
    measurement_type: 'duration',
    color: '#8B5CF6',
    streak_count: 3,
    allows_skips: true,
    completedToday: false
  },
  {
    id: 'habit-3',
    name: 'Reading',
    type: 'build',
    measurement_type: 'boolean',
    color: '#3B82F6',
    streak_count: 7,
    allows_skips: false,
    completedToday: true
  },
  {
    id: 'habit-4',
    name: 'Drink Water',
    type: 'build',
    measurement_type: 'count',
    color: '#06B6D4',
    streak_count: 2,
    allows_skips: false,
    completedToday: false
  }
];
---

<Layout title="Mobile Quick Actions Test">
  <div class="min-h-screen bg-slate-900 p-4">
    <div class="max-w-md mx-auto">
      <h1 class="text-2xl font-bold text-white mb-6 text-center">
        Mobile Quick Actions Test
      </h1>
      
      <div class="mb-4 text-center">
        <p class="text-gray-400 text-sm">
          Test the mobile quick actions widget below
        </p>
        <p class="text-gray-500 text-xs mt-1">
          Try swiping, batch mode, and quick logging
        </p>
      </div>

      <!-- Mobile Quick Actions Widget -->
      <div id="mobile-quick-actions-container"></div>
      
      <!-- Test Controls -->
      <div class="mt-8 space-y-4">
        <div class="bg-slate-800 rounded-lg p-4">
          <h3 class="text-white font-medium mb-2">Test Controls</h3>
          <div class="space-y-2">
            <button 
              id="toggle-offline" 
              class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors"
            >
              Toggle Offline Mode
            </button>
            <button 
              id="add-offline-entry" 
              class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
            >
              Add Offline Entry
            </button>
            <button 
              id="sync-offline" 
              class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
            >
              Sync Offline Queue
            </button>
          </div>
        </div>
        
        <!-- Status Display -->
        <div class="bg-slate-800 rounded-lg p-4">
          <h3 class="text-white font-medium mb-2">Status</h3>
          <div id="status-display" class="text-sm text-gray-400">
            Online: <span id="online-status">true</span><br>
            Offline Queue: <span id="queue-count">0</span> entries
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Habits data for the component -->
  <script type="application/json" id="habits-data">
    {JSON.stringify({ habits: mockHabits })}
  </script>
</Layout>

<script>
  import MobileQuickActionsWrapper from '../components/habits/MobileQuickActionsWrapper';
  import { createRoot } from 'react-dom/client';
  import React from 'react';

  // Get habits data
  const habitsDataScript = document.getElementById('habits-data');
  const habitsData = habitsDataScript ? JSON.parse(habitsDataScript.textContent) : { habits: [] };

  // Mock functions for testing
  const mockOnQuickLog = async (habitId, value) => {
    console.log('Quick log:', habitId, value);
    showToast(`Logged habit ${habitId} with value ${value}`);
    
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Simulate occasional failure for testing
    if (Math.random() < 0.2) {
      throw new Error('Simulated network error');
    }
  };

  const mockOnBatchComplete = async (habitIds) => {
    console.log('Batch complete:', habitIds);
    showToast(`Completed ${habitIds.length} habits`);
    
    // Simulate API delay
    await new Promise(resolve => setTimeout(resolve, 1000));
  };

  const mockOnEnhancedLog = (habitId, habitName) => {
    console.log('Enhanced log:', habitId, habitName);
    showToast(`Opening enhanced log for ${habitName}`);
  };

  // Render the component
  const container = document.getElementById('mobile-quick-actions-container');
  if (container) {
    const root = createRoot(container);
    root.render(
      React.createElement(MobileQuickActionsWrapper, {
        habitsData,
        onQuickLog: mockOnQuickLog,
        onBatchComplete: mockOnBatchComplete,
        onEnhancedLog: mockOnEnhancedLog
      })
    );
  }

  // Test controls
  let isOffline = false;
  
  document.getElementById('toggle-offline')?.addEventListener('click', () => {
    isOffline = !isOffline;
    
    // Mock navigator.onLine
    Object.defineProperty(navigator, 'onLine', {
      writable: true,
      value: !isOffline
    });
    
    // Dispatch online/offline events
    window.dispatchEvent(new Event(isOffline ? 'offline' : 'online'));
    
    updateStatus();
    showToast(isOffline ? 'Went offline' : 'Came online');
  });

  document.getElementById('add-offline-entry')?.addEventListener('click', () => {
    // Simulate adding an offline entry
    const habitId = 'habit-' + Math.floor(Math.random() * 4 + 1);
    const value = Math.floor(Math.random() * 2 + 1);
    
    // Add to localStorage (simulating offline queue)
    const queue = JSON.parse(localStorage.getItem('habitOfflineQueue') || '[]');
    queue.push({
      id: `offline_${Date.now()}`,
      habitId,
      value,
      date: new Date().toISOString().split('T')[0],
      timestamp: Date.now(),
      synced: false,
      retryCount: 0
    });
    localStorage.setItem('habitOfflineQueue', JSON.stringify(queue));
    
    updateStatus();
    showToast('Added offline entry');
  });

  document.getElementById('sync-offline')?.addEventListener('click', () => {
    // Trigger sync event
    window.dispatchEvent(new CustomEvent('habitSyncComplete', {
      detail: { success: 1, failed: 0, remaining: 0 }
    }));
    
    // Clear offline queue
    localStorage.setItem('habitOfflineQueue', '[]');
    
    updateStatus();
    showToast('Synced offline entries');
  });

  function updateStatus() {
    const onlineStatus = document.getElementById('online-status');
    const queueCount = document.getElementById('queue-count');
    
    if (onlineStatus) {
      onlineStatus.textContent = navigator.onLine.toString();
    }
    
    if (queueCount) {
      const queue = JSON.parse(localStorage.getItem('habitOfflineQueue') || '[]');
      queueCount.textContent = queue.length.toString();
    }
  }

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg z-50 text-sm';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  // Initial status update
  updateStatus();

  // Listen for storage changes
  window.addEventListener('storage', updateStatus);
  
  // Listen for sync events
  window.addEventListener('habitSyncComplete', updateStatus);
</script>

<style>
  /* Ensure mobile-first design */
  @media (min-width: 768px) {
    .max-w-md {
      max-width: 400px;
    }
  }
</style>