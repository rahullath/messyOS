---
// Test page to check if session detection is working
import { createServerAuth } from '../lib/auth/simple-multi-user';

const serverAuth = createServerAuth(Astro.cookies);

let user = null;
let error = null;

try {
  user = await serverAuth.getUser();
} catch (e) {
  error = e.message;
}

console.log('ðŸ§ª Test session page - User:', user?.email || 'none', 'Error:', error || 'none');
---

<!DOCTYPE html>
<html>
<head>
  <title>Session Test</title>
</head>
<body style="font-family: system-ui; padding: 20px; background: #1a1a1a; color: white;">
  <h1>Session Test</h1>
  
  <div style="margin: 20px 0;">
    <h2>Server-side Results:</h2>
    <p><strong>User:</strong> {user?.email || 'No user found'}</p>
    <p><strong>User ID:</strong> {user?.id || 'No user ID'}</p>
    <p><strong>Error:</strong> {error || 'No error'}</p>
  </div>

  <div style="margin: 20px 0;">
    <h2>Client-side Test:</h2>
    <p id="client-result">Loading...</p>
  </div>

  <div style="margin: 20px 0;">
    <h2>Actions:</h2>
    <button onclick="testLogin()" style="padding: 10px; margin: 5px;">Test Google Login</button>
    <button onclick="testLogout()" style="padding: 10px; margin: 5px;">Test Logout</button>
    <button onclick="checkSession()" style="padding: 10px; margin: 5px;">Check Session</button>
  </div>

  <div style="margin: 20px 0;">
    <h2>Logs:</h2>
    <div id="logs" style="background: #2a2a2a; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto;"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
    
    const supabase = createClient(
      'https://mdhtpjpwwbuepsytgrva.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kaHRwanB3d2J1ZXBzeXRncnZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMTQ0NTQsImV4cCI6MjA2Mzc5MDQ1NH0.T5eIZsKrpivj9Q4QniFhqOBGF_QU3f32wc0rcz4S-fA'
    );

    function log(message) {
      const logs = document.getElementById('logs');
      const time = new Date().toLocaleTimeString();
      logs.innerHTML += `<div>[${time}] ${message}</div>`;
      logs.scrollTop = logs.scrollHeight;
      console.log(message);
    }

    async function checkSession() {
      log('ðŸ” Checking client session...');
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          log(`âŒ Session error: ${error.message}`);
        } else if (session) {
          log(`âœ… Session found: ${session.user.email}`);
          document.getElementById('client-result').textContent = `Logged in as: ${session.user.email}`;
        } else {
          log('ðŸš« No session found');
          document.getElementById('client-result').textContent = 'No session found';
        }
      } catch (e) {
        log(`âŒ Session check failed: ${e.message}`);
      }
    }

    window.testLogin = async function() {
      log('ðŸš€ Starting Google OAuth...');
      try {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: {
            redirectTo: `${window.location.origin}/test-session`
          }
        });
        
        if (error) {
          log(`âŒ OAuth error: ${error.message}`);
        } else {
          log('ðŸ”„ Redirecting to Google...');
        }
      } catch (e) {
        log(`âŒ OAuth failed: ${e.message}`);
      }
    };

    window.testLogout = async function() {
      log('ðŸ‘‹ Signing out...');
      try {
        const { error } = await supabase.auth.signOut();
        if (error) {
          log(`âŒ Logout error: ${error.message}`);
        } else {
          log('âœ… Logged out successfully');
          document.getElementById('client-result').textContent = 'Logged out';
        }
      } catch (e) {
        log(`âŒ Logout failed: ${e.message}`);
      }
    };

    window.checkSession = checkSession;

    // Initialize
    checkSession();

    // Listen for auth state changes
    supabase.auth.onAuthStateChange((event, session) => {
      log(`ðŸ”„ Auth state change: ${event}, session: ${session ? session.user.email : 'none'}`);
      if (session) {
        document.getElementById('client-result').textContent = `Logged in as: ${session.user.email}`;
      } else {
        document.getElementById('client-result').textContent = 'No session';
      }
    });
  </script>
</body>
</html>