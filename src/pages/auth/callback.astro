---
// OAuth callback handler - client-side processing for PKCE compatibility
const url = new URL(Astro.request.url);
const error = url.searchParams.get('error');

// Handle OAuth errors on server-side
if (error) {
  console.error('OAuth error:', error);
  return Astro.redirect('/login?error=oauth_failed');
}
---

<!DOCTYPE html>
<html>
<head>
  <title>Completing Login...</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { 
      font-family: system-ui; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 100vh; 
      margin: 0; 
      background: linear-gradient(135deg, #1e293b, #334155);
      color: white;
    }
    .spinner { 
      width: 40px; 
      height: 40px; 
      border: 4px solid #64748b; 
      border-top: 4px solid #06b6d4; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
      margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div style="text-align: center;">
    <div class="spinner" id="spinner"></div>
    <p id="status">Completing your authentication...</p>
    <p style="color: #64748b; font-size: 14px;" id="substatus">Please wait...</p>
  </div>

  <script>
    // Client-side OAuth callback handling with server session synchronization
    console.log('ðŸ”„ OAuth callback received, processing with PKCE + server sync...');
    
    // Fetch Supabase config from server
    fetch('/api/auth/config')
      .then(async (response) => {
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          throw new Error(payload?.error || 'Failed to load auth config');
        }
        return payload;
      })
      .then(config => {
        // Import Supabase dynamically to avoid module loading issues
        return import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm')
          .then(({ createClient }) => {
            const supabase = createClient(config.url, config.key, {
              auth: {
                flowType: 'pkce',
                autoRefreshToken: true,
                detectSessionInUrl: true,
                persistSession: true
              }
            });
            
            return handleAuthCallback(supabase);
          });
      })
      .catch(error => {
        console.error('âŒ Failed to initialize Supabase client:', error);
        window.location.href = '/login?error=client_init_failed';
      });
    
    function updateStatus(message, submessage = '') {
      document.getElementById('status').textContent = message;
      document.getElementById('substatus').textContent = submessage;
    }
    
    async function handleAuthCallback(supabase) {
      try {
        console.log('ðŸ” Processing OAuth callback with PKCE...');
        updateStatus('Processing authentication...', 'Verifying OAuth code...');
        const urlParams = new URLSearchParams(window.location.search);
        const authCode = urlParams.get('code');
        
        // Let Supabase handle the OAuth callback automatically
        // This will process the code and code_verifier from the URL
        const { data, error } = await supabase.auth.getSession();
        
        if (error) {
          console.error('âŒ Session retrieval error:', error);
          updateStatus('Authentication failed', error.message);
          setTimeout(() => window.location.href = '/login?error=session_failed', 3000);
          return;
        }
        
        if (data.session) {
          console.log('âœ… OAuth callback successful for user:', data.session.user.email);
          updateStatus('Authentication successful!', 'Syncing with server...');
          await syncSessionWithServer(data.session);
        } else {
          console.log('âš ï¸ No session found from getSession, trying manual code exchange...');
          updateStatus('Finalizing authentication...', 'Exchanging auth code...');

          if (authCode) {
            try {
              const { data: exchangeData, error: exchangeError } = await supabase.auth.exchangeCodeForSession(authCode);

              if (exchangeError) {
                console.error('âŒ Manual exchange failed:', exchangeError);
              } else if (exchangeData?.session) {
                console.log('âœ… Manual code exchange successful:', exchangeData.session.user.email);
                await syncSessionWithServer(exchangeData.session);
                return;
              }
            } catch (exchangeException) {
              console.error('âŒ Manual exchange exception:', exchangeException);
            }
          }

          console.log('âš ï¸ Manual exchange did not produce a session, waiting for auth state change...');
          updateStatus('Finalizing authentication...', 'Please wait...');
          
          // Listen for auth state changes
          const { data: { subscription } } = supabase.auth.onAuthStateChange(async (event, session) => {
            console.log(`ðŸ”„ Auth state change: ${event}`);
            
            if (event === 'SIGNED_IN' && session) {
              console.log('âœ… Auth state change detected, user signed in:', session.user.email);
              subscription.unsubscribe();
              updateStatus('Authentication successful!', 'Syncing with server...');
              await syncSessionWithServer(session);
            } else if (event === 'SIGNED_OUT') {
              console.log('âŒ Sign out detected during callback');
              subscription.unsubscribe();
              updateStatus('Authentication failed', 'Session was terminated');
              setTimeout(() => window.location.href = '/login?error=signed_out', 3000);
            }
          });
          
          // Fallback timeout
          setTimeout(() => {
            subscription.unsubscribe();
            console.log('âš ï¸ Auth timeout, redirecting to login');
            updateStatus('Authentication timeout', 'Please try again');
            setTimeout(() => window.location.href = '/login?error=timeout', 3000);
          }, 10000);
        }
      } catch (error) {
        console.error('âŒ Callback processing error:', error);
        updateStatus('Authentication failed', error.message || 'Unknown error');
        setTimeout(() => window.location.href = '/login?error=processing_failed', 3000);
      }
    }
    
    async function syncSessionWithServer(session) {
      try {
        console.log('ðŸ”„ Syncing session with server...');
        
        // Send complete session data to server to set proper cookies
        const response = await fetch('/api/auth/session', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            access_token: session.access_token,
            refresh_token: session.refresh_token,
            expires_at: session.expires_at,
            expires_in: session.expires_in,
            token_type: session.token_type,
            user: session.user
          }),
          credentials: 'same-origin' // Ensure cookies are sent
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('âœ… Session synced with server successfully:', result);
          updateStatus('Welcome back!', `Redirecting to dashboard...`);
          document.getElementById('spinner').style.display = 'none';
          setTimeout(() => window.location.href = '/dashboard', 1500);
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('âŒ Failed to sync session with server:', errorData);
          updateStatus('Sync failed', errorData.details || 'Please try signing in again');
          setTimeout(() => window.location.href = '/login?error=session_sync_failed', 3000);
        }
      } catch (error) {
        console.error('âŒ Session sync error:', error);
        updateStatus('Sync error', 'Please try signing in again');
        setTimeout(() => window.location.href = '/login?error=session_sync_error', 3000);
      }
    }
  </script>
</body>
</html>
