---
// src/layouts/DashboardLayout.astro
import Layout from './Layout.astro';
import TokenBalance from '../components/dashboard/TokenBalance.tsx';

export interface Props {
  title: string;
  user?: any;
}

const { title, user } = Astro.props;
const pathname = Astro.url.pathname;

const navItems = [
  { href: '/dashboard', label: 'Dashboard' },
  { href: '/daily-plan', label: 'Daily Plan' },
  { href: '/habits', label: 'Habits' },
  { href: '/calendar', label: 'Calendar' },
  { href: '/import', label: 'Import' },
  { href: '/profile', label: 'Profile' },
  { href: '/billing', label: 'Subscription' },
  { href: '/settings', label: 'Settings' },
] as const;

function isActive(href: string) {
  return pathname === href;
}
---

<Layout title={title}>
  <div class="min-h-screen bg-background">
    <aside class="hidden lg:block fixed inset-y-0 left-0 w-64 bg-surface border-r border-border">
      <div class="flex flex-col h-full">
        <div class="flex items-center h-16 px-6 border-b border-border">
          <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-accent-primary rounded-lg flex items-center justify-center">
              <span class="text-sm font-bold text-white">M</span>
            </div>
            <span class="text-xl font-semibold text-primary">MeshOS</span>
          </div>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-2">
          {navItems.map((item) => (
            <a
              href={item.href}
              class:list={[
                'flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors',
                isActive(item.href)
                  ? 'bg-accent-primary/10 text-accent-primary'
                  : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
              ]}
            >
              {item.label}
            </a>
          ))}
        </nav>

        <div class="px-4 py-4 border-t border-border">
          <div class="flex items-center space-x-3 px-3 py-2 rounded-lg bg-surface-hover">
            <div class="w-8 h-8 bg-gradient-to-r from-accent-primary to-accent-purple rounded-full flex items-center justify-center">
              <span class="text-sm font-medium text-white">{user?.user_metadata?.full_name?.[0] || user?.email?.[0]?.toUpperCase() || 'U'}</span>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-text-primary truncate">{user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'User'}</p>
              <p class="text-xs text-text-muted truncate">{user?.email || 'user@example.com'}</p>
            </div>
          </div>
          <button
            id="logout-button"
            type="button"
            class="mt-3 w-full px-3 py-2 text-sm font-medium rounded-lg border border-border text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors text-left"
          >
            Log out
          </button>
        </div>
      </div>
    </aside>

    <div class="lg:ml-64 min-h-screen pb-24 lg:pb-0">
      <header class="bg-surface border-b border-border">
        <div class="px-4 sm:px-6 py-4">
          <div class="flex items-center justify-between gap-3">
            <div class="flex items-center gap-3 min-w-0">
              <div class="lg:hidden w-8 h-8 bg-accent-primary rounded-lg flex items-center justify-center shrink-0">
                <span class="text-xs font-bold text-white">M</span>
              </div>
              <div class="min-w-0">
                <p class="text-sm text-text-muted">MeshOS</p>
                <p class="text-sm sm:text-base text-text-primary truncate">{title.replace(' - MeshOS', '')}</p>
              </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-4 shrink-0">
              <div class="hidden sm:block">
                <TokenBalance client:load />
              </div>
              <button
                id="mobile-logout-button"
                type="button"
                class="lg:hidden px-3 py-2 text-xs font-medium rounded-lg border border-border text-text-secondary hover:text-text-primary hover:bg-surface-hover transition-colors"
              >
                Log out
              </button>
              <button class="px-3 py-2 text-sm font-medium bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 transition-colors">
                Quick Add
              </button>
            </div>
          </div>
        </div>
      </header>

      <main class="p-4 sm:p-6">
        <slot />
      </main>
    </div>

    <nav class="block lg:hidden fixed bottom-0 inset-x-0 z-50 border-t border-border bg-surface/98 backdrop-blur-sm shadow-[0_-6px_20px_rgba(0,0,0,0.35)] pb-[max(env(safe-area-inset-bottom),0.5rem)]">
      <div class="grid grid-cols-6 gap-1 px-2 pt-2">
        <a
          href="/dashboard"
          aria-label="Home"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/dashboard')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 10.5L12 3l9 7.5" />
            <path d="M5 9.5V20h14V9.5" />
          </svg>
          <span>Home</span>
        </a>
        <a
          href="/daily-plan"
          aria-label="Plan"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/daily-plan')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 3h6" />
            <path d="M10 3v2" />
            <path d="M14 3v2" />
            <rect x="5" y="5" width="14" height="16" rx="2" />
            <path d="M8 10h8M8 14h6" />
          </svg>
          <span>Plan</span>
        </a>
        <a
          href="/habits"
          aria-label="Habits"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/habits')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M8 4v16" />
            <path d="M8 5h6a3 3 0 010 6H8" />
            <path d="M8 11h7a3 3 0 010 6H8" />
          </svg>
          <span>Habits</span>
        </a>
        <a
          href="/calendar"
          aria-label="Calendar"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/calendar')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="17" rx="2" />
            <path d="M3 9h18M8 3v3M16 3v3" />
          </svg>
          <span>Calendar</span>
        </a>
        <a
          href="/import"
          aria-label="Import"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/import')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 3v12" />
            <path d="M7 10l5 5 5-5" />
            <rect x="4" y="17" width="16" height="4" rx="1" />
          </svg>
          <span>Import</span>
        </a>
        <a
          href="/profile"
          aria-label="Account"
          class:list={[
            'min-h-14 rounded-xl flex flex-col items-center justify-center gap-0.5 text-[11px] font-medium transition-colors',
            isActive('/profile') || isActive('/billing') || isActive('/settings')
              ? 'bg-accent-primary/18 text-accent-primary'
              : 'text-text-secondary hover:text-text-primary hover:bg-surface-hover',
          ]}
        >
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="8" r="4" />
            <path d="M4 21a8 8 0 0116 0" />
          </svg>
          <span>Account</span>
        </a>
      </div>
    </nav>
  </div>
</Layout>

<script>
  const logoutButton = document.getElementById('logout-button');
  const mobileLogoutButton = document.getElementById('mobile-logout-button');

  async function performLogout() {
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
    } finally {
      window.location.href = '/login';
    }
  }

  logoutButton?.addEventListener('click', () => {
    performLogout();
  });
  mobileLogoutButton?.addEventListener('click', () => {
    performLogout();
  });
</script>
